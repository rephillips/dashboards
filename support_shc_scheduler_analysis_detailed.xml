<form version="1.1" hideEdit="false" script="common_control.js, table_cell_highlighting.js, table_cell_highlighting1.js" stylesheet="shared.css, health-check.css, table_cell_highlighting.css" theme="light">
  <label>support_shc_scheduler_analysis_detailed</label>
  <search>
    <query>|rest splunk_server_group=dmc_group_search_head splunk_server_group="$group$"  /services/shcluster/status|head 1|fields captain.label|rename captain.label AS captain_label</query>
    <done>
      <set token="captain_name">$result.captain_label$</set>
    </done>
  </search>

  <search id="shcSearchConBase">
    <query>
        `dmc_set_index_introspection` search_group=dmc_group_search_head search_group="$group$" sourcetype=splunk_resource_usage ((component=PerProcess data.search_props.sid::*) OR component=Hostwide)
        | `dmc_rename_introspection_fields`
        | `dmc_set_bin`
        | stats dc(sid) AS distinct_search_count by provenance, mode, app, type, user, host, _time
        </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="captainElectionBaseSearch">
    <query>
`dmc_set_index_internal` search_group="$group$" sourcetype=splunkd component=Metrics group=captainstability upgrades_to_captain=1
| stats count by _time, upgrades_to_captain, host
        </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="captainSnapshotSearch">
    <query>
      | rest splunk_server_group=$group$ splunk_server_group=dmc_group_search_head /services/shcluster/captain/info
      | dedup peer_scheme_host_port
      | fields label
    </query>
    <finalized>
      <set token="captain_name">$result.label$</set>
    </finalized>
  </search>
  <search id="membersSnapshotSearch">
    <query>
| rest splunk_server=local /services/search/distributed/peers
| where search_groups="$group$" AND server_roles="search_head"
| eval label = host
| join guid type=outer [
  | rest splunk_server_group="$group$" splunk_server_group=dmc_group_search_head /services/shcluster/member/members count=0
  | dedup label
  | eval guid = title
]
| join label type=outer [
  | rest splunk_server=$captain_name$ /services/shcluster/captain/members count=0
  | where splunk_server == label
  | fields label, last_heartbeat
  | rename last_heartbeat as last_heartbeat_captain
]
| eventstats values(last_heartbeat_captain) as last_heartbeat_captain
| join label type=outer [
  | rest splunk_server_group="$group$" splunk_server_group=dmc_group_search_head /services/shcluster/captain/info
  | where splunk_server == label
  | eval age = now() - elected_captain
  | eval captain_age = case(age &lt; 60, "&lt; 1m", age &gt;= 60 AND age &lt; 3600, round(age / 60, 0)."m", age &gt;= 3600 AND age &lt; 86400, round(age / 3600, 0)."h", age &gt;= 86400, round(age / 86400, 0)."d")
  | `dmc_time_format(elected_captain)`
  | eval role = "Captain (" . captain_age . ")"
  | fields label captain_age elected_captain role
]
| join label type=outer [
  | rest /services/replication/configuration/health check_share_baseline=1 splunk_server_group="$group$" splunk_server_group=dmc_group_search_head
  | stats values(server_name) as baselines, count(server_name) as num_baselines by splunk_server, check_share_baseline
  | eval shared_common_baseline = if(check_share_baseline == "Yes", baselines, "")
  | eval no_shared_common_baseline = if(check_share_baseline == "No", baselines, "")
  | eval unable_to_connect = if(check_share_baseline == "Connection error", baselines, "")
  | eval num_shared_common_baseline = if(check_share_baseline == "Yes", num_baselines, 0)
  | eval num_no_shared_common_baseline = if(check_share_baseline == "No", num_baselines, 0)
  | eval num_unable_to_connect = if(check_share_baseline == "Connection error", num_baselines, 0)
  | stats sum(num_shared_common_baseline) as total_shared_common_baseline, sum(num_no_shared_common_baseline) as total_no_shared_common_baseline, sum(num_unable_to_connect) as total_unable_to_connect, values(shared_common_baseline) as shared_common_baseline, values(no_shared_common_baseline) as no_shared_common_baseline, values(unable_to_connect) as unable_to_connect by splunk_server
  | eval ratio = total_shared_common_baseline . "/" . (total_shared_common_baseline+total_no_shared_common_baseline+total_unable_to_connect)
  | rename splunk_server as label
]
| join label type=outer [
  | rest /services/replication/configuration/health unpublished=1 splunk_server_group="$group$" splunk_server_group=dmc_group_search_head
  | rename "Number of unpublished changes" as unpublished_changes
  | eval unpublished_changes=if(unpublished_changes=="0 (this instance is the captain)", 0, unpublished_changes)
  | rename splunk_server as label
]
| eval role = if(isnotnull(role), role, "Member")
| sort role
    </query>
  </search>
  <fieldset submitButton="false">
    <input type="dropdown" searchWhenChanged="true" token="group">
      <label>Search Head Cluster:</label>
      <showClearButton>false</showClearButton>
      <populatingSearch fieldForLabel="label" fieldForValue="search_group">| `dmc_get_search_head_cluster_groups`</populatingSearch>
      <selectFirstChoice>true</selectFirstChoice>
      <fieldForLabel>label</fieldForLabel>
      <fieldForValue>search_group</fieldForValue>
    </input>
    <input type="time" token="time" searchWhenChanged="true">
      <label></label>
      <default>
        <earliest>-60m@m</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>SHC Captain: $captain_name$</title>
      <table>
        <search>
          <query>| rest splunk_server_group=dmc_group_search_head splunk_server_group="$group$" /services/server/info
              | fields splunk_server,version,physicalMemoryMB, numberOfCores, numberOfVirtualCores</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <drilldown>
          <link target="_blank">search?q=| rest /servicesNS/-/-/saved/searches splunk_server=$captain_name$ | where is_scheduled=1 | search disabled=0  | stats count by  title next_scheduled_time cron_schedule schedule_priority schedule_window dispatch.earliest_time dispatch.latest_time| fields title next_scheduled_time cron_schedule schedule_priority schedule_window dispatch.earliest_time dispatch.latest_time| rename title as savedsearch_name | join savedsearch_name [search index=_internal search_group=dmc_group_search_head search_group="dmc_searchheadclustergroup_shcluster1" sourcetype=scheduler  status=*  dispatch_time=*]&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>scheduled searches &amp; data model accelerations</title>
      <single>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server=$captain_name$  | search  disabled=0 is_scheduled=1| table title  cron_schedule dispatch.earliest_time dispatch.latest_time auto_summarize  action.email realtime_schedule eai:acl.app eai:acl.owner schedule_priority auto_summarize.dispatch.earliest_time auto_summarize.dispatch.latest_time allow_skew  action.summary_index | append [ | rest /servicesNS/-/-/data/models splunk_server=$captain_name$ | search acceleration=1 | table title acceleration.cron_schedule acceleration.earliest_time acceleration.max_time dataset.type eai:acl.app eai:acl.owner  | rename acceleration.cron_schedule as acceleration_cron_schedule acceleration.earliest_time as acceleration_et acceleration.max_time as acceleration_max_time dataset.type as dataset_type eai:acl.app as app eai:acl.owner as owner] | stats count</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
        <option name="rangeValues">[0]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">click for detail</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="ss_count">$click.value$</set>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>scheduled searches running over All Time</title>
      <single>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server="$captain_name$" | where is_scheduled=1 | search disabled=0 | search title!="Bucket Copy Trigger"   dispatch.earliest_time="" OR dispatch.earliest_time=0  | rename eai:acl.* as *  | table title cron_schedule dispatch.earliest_time dispatch.latest_time app owner search | search search!=*earliest* | search search=*index*
  | stats count</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="colorMode">none</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0xf1813f","0xd93f3c"]</option>
        <option name="rangeValues">[0,1]</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="underLabel">click for detail</option>
        <option name="unitPosition">after</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
        <drilldown>
          <set token="count">$click.value$</set>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>Real Time Searches Running</title>
      <single>
        <search>
          <query>index=_introspection search_group=dmc_group_search_head search_group=$group$ sourcetype=splunk_resource_usage (component=PerProcess data.search_props.sid::*)    "data.search_props.mode"=RT* | dedup "data.search_props.label" | table data.search_props.label data.search_props.app data.search_props.mode data.search_props.sid data.elapsed | rename data.search_props.label as "savedsearch name" data.search_props.app as app data.search_props.mode as mode data.search_props.sid as sid data.elapsed as "has been running for (seconds)" | stats count</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,1]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">click for detail</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="rt_count">$click.value$</set>
        </drilldown>
      </single>
    </panel>
  </row>
  <row>
    <panel depends="$rt_count$">
      <title>Real Time Searches Running in the last $time.earliest$</title>
      <html>
    <a data-unset-token="rt_count">Close this panel</a>
  </html>
      <table>
        <search>
          <query>index=_introspection search_group=dmc_group_search_head search_group=$group$ sourcetype=splunk_resource_usage (component=PerProcess data.search_props.sid::*)    "data.search_props.mode"=RT* | dedup "data.search_props.label" | table data.search_props.label data.search_props.app data.search_props.user data.search_props.type data.search_props.mode data.search_props.sid data.elapsed | rename data.search_props.label as "savedsearch name" data.search_props.app as app data.search_props.user as user data.search_props.type as type data.search_props.mode as mode data.search_props.sid as sid data.elapsed as "has been running for (seconds)"</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel depends="$rt_count$">
      <title>Real Time Searches timechart of elapsed time</title>
      <chart>
        <search>
          <query>index=_introspection search_group=dmc_group_search_head search_group=$group$ source=*resource_usage.log* component=PerProcess "data.search_props.sid"=* "data.search_props.mode"=RT* | timechart span=30s max(data.elapsed) by data.search_props.sid useother=f limit=0</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">elapsed time (sec)</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel depends="$ss_count$">
      <title>scheduled searches configured</title>
      <html>
    <a data-unset-token="ss_count">Close this panel</a>
  </html>
      <table>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server=$captain_name$  | search  disabled=0 is_scheduled=1| table title  cron_schedule dispatch.earliest_time dispatch.latest_time auto_summarize  action.email realtime_schedule eai:acl.app eai:acl.owner schedule_priority auto_summarize.dispatch.earliest_time auto_summarize.dispatch.latest_time allow_skew  action.summary_index search  | append [ | rest /servicesNS/-/-/data/models splunk_server=$captain_name$ | search acceleration=1 | table title acceleration.cron_schedule acceleration.earliest_time acceleration.max_time dataset.type eai:acl.app eai:acl.owner  | rename acceleration.cron_schedule as acceleration_cron_schedule acceleration.earliest_time as acceleration_et acceleration.max_time as acceleration_max_time dataset.type as dataset_type eai:acl.app as app eai:acl.owner as owner ]</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">5</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel depends="$count$">
      <table>
        <title>scheduled searches running over All Time</title>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server="$captain_name$" | where is_scheduled=1 | search disabled=0   | search title!="Bucket Copy Trigger" dispatch.earliest_time="" OR dispatch.earliest_time=0  | rename eai:acl.* as *  | table title cron_schedule dispatch.earliest_time dispatch.latest_time app owner search | search search!=*earliest* | search search=*index*</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
      <html>
    <a data-unset-token="count">Close this panel</a>
  </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Search Head Cluster Delegated Searches by Captain</title>
      <input type="dropdown" token="span1" searchWhenChanged="true">
        <label>span</label>
        <choice value="span=1m">1m</choice>
        <choice value="span=5m">5m</choice>
        <choice value="span=10m">10m</choice>
        <choice value="span=15m">15m</choice>
        <choice value="minspan=10s">auto</choice>
        <fieldForLabel>span1</fieldForLabel>
        <fieldForValue>span1</fieldForValue>
        <default>minspan=10s</default>
        <initialValue>minspan=10s</initialValue>
      </input>
      <chart>
        <title>shc captaincy timeline</title>
        <search>
          <query>`dmc_set_index_internal` sourcetype=splunkd group=searchscheduler search_group=dmc_group_search_head search_group="$group$"
| eval state=if(delegated&gt;0, "captain", "non-captain")
| search state="captain"
| timechart $span1$ distinct_count(state) by host</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <search type="annotation">
          <query>`dmc_set_index_internal` search_group=$group$ sourcetype=splunkd component=Metrics group=captainstability upgrades_to_captain=1 | eval msg="Became SHC Captain"
| eval annotation_label = msg
| eval annotation_category = host</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">1</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel rejects="$snapshot$">
      <title>Search Concurrency</title>
      <input type="dropdown" token="shcSearchConFunc" searchWhenChanged="true">
        <label>Aggregation</label>
        <showClearButton>false</showClearButton>
        <default>Max</default>
        <choice value="Avg">Average</choice>
        <choice value="Median">Median</choice>
        <choice value="Min">Minimum</choice>
        <choice value="Max">Maximum</choice>
        <choice value="Perc90">90th Percentile</choice>
        <choice value="First">Sampled</choice>
      </input>
      <input type="dropdown" token="shcSearchConHostScope" searchWhenChanged="true">
        <label>Instance</label>
        <showClearButton>false</showClearButton>
        <default>*</default>
        <choice value="*">All</choice>
        <fieldForLabel>host</fieldForLabel>
        <fieldForValue>host</fieldForValue>
        <prefix>search host="</prefix>
        <suffix>"</suffix>
        <search base="shcSearchConBase">
          <query>stats count by host</query>
        </search>
      </input>
      <input type="dropdown" token="shcSearchConSplitBy" searchWhenChanged="true">
        <label>Split by</label>
        <showClearButton>false</showClearButton>
        <default>host</default>
        <choice value="app">app</choice>
        <choice value="user">user</choice>
        <choice value="provenance">provenance</choice>
        <choice value="mode">mode</choice>
        <choice value="type">type</choice>
        <choice value="host">host</choice>
      </input>
      <input type="radio" token="searchConVizMode" searchWhenChanged="true">
        <label>Viz Mode</label>
        <default>column</default>
        <choice value="line">Line</choice>
        <choice value="column">Stacked Column</choice>
        <initialValue>column</initialValue>
      </input>
      <chart>
        <search base="shcSearchConBase">
          <query>
          $shcSearchConHostScope$
          | stats sum(distinct_search_count) as total_distinct_search_count by provenance, mode, app, type, user, host, _time
          | `dmc_timechart` partial=false $shcSearchConFunc$(total_distinct_search_count) as search_count by $shcSearchConSplitBy$
          </query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisLabelsY.majorUnit">1</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Count</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">$searchConVizMode$</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">zero</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.chart.showLabels">auto</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Deployment-Wide Total Concurrent Searches</title>
      <chart>
        <search>
          <query>`dmc_set_index_introspection` search_group=dmc_group_search_head search_group="$group$" sourcetype=splunk_resource_usage ((component=PerProcess data.search_props.sid::*) OR component=Hostwide) "data.search_props.type"=* | bin _time span=10s | stats dc(data.search_props.sid) AS distinct_search_count by _time | stats sum(distinct_search_count) AS distinct_search_count by _time | timechart minspan=10s max(distinct_search_count) AS distinct_search_count  | join dmc_group_search_head search_group [| rest splunk_server_group="$group$" splunk_server_group=dmc_group_search_head "/services/server/status/limits/search-concurrency?cluster_wide_quota=1"
              | stats max(max_hist_searches) as max_clusterwide_concurrency]</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.overlayFields">max_clusterwide_concurrency,max_clusterwide_scheduler_concurrency</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
    <panel>
      <title>Deployment-Wide Total Concurrent Scheduled Searches</title>
      <chart>
        <search>
          <query>`dmc_set_index_introspection` search_group=dmc_group_search_head search_group="$group$" sourcetype=splunk_resource_usage ((component=PerProcess data.search_props.sid::*) OR component=Hostwide) "data.search_props.type"!="ad-hoc" | bin _time span=10s | stats dc(data.search_props.sid) AS distinct_search_count by _time | stats sum(distinct_search_count) AS distinct_search_count by _time | timechart minspan=10s max(distinct_search_count) AS distinct_search_count  | join dmc_group_search_head search_group [| rest splunk_server_group="$group$" splunk_server_group=dmc_group_search_head "/services/server/status/limits/search-concurrency?cluster_wide_quota=1"
              | stats max(max_hist_scheduled_searches) as max_clusterwide_scheduler_concurrency max(max_auto_summary_searches) as max_auto_summary_searches]</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.overlayFields">max_clusterwide_concurrency,max_clusterwide_scheduler_concurrency,max_auto_summary_searches</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>number of scheduled searches configured for each minute in the hour</title>
      <chart>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server=$captain_name$
search="is_scheduled=1" search="disabled=0" earliest_time=-1h@m latest_time=now
          | table title cron_schedule scheduled_times
          | mvexpand scheduled_times
          | rename scheduled_times as _time
          | timechart span=1m count as "Searches Scheduled" | join splunk_server [| rest splunk_server=$captain_name$ "/services/server/status/limits/search-concurrency?cluster_wide_quota=1"
              | stats max(max_hist_scheduled_searches) as max_clusterwide_scheduler_concurrency ]</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">minute of the hour</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">max_clusterwide_scheduler_concurrency</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <drilldown>
          <set token="c1">$click.value$</set>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel depends="$c1$">
      <title>number of searches scheduled at $c1$</title>
      <table>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server=$captain_name$
    search="is_scheduled=1" search="disabled=0" earliest_time=-1h@m latest_time=now
| mvexpand scheduled_times

| search scheduled_times=$c1$
| table title scheduled_times eai:acl.app eai:acl.owner | rename title as savedsearch_name eai:acl.app as app eai:acl.owner as owner | convert ctime(scheduled_times) as scheduled_times | stats values(savedsearch_name) as savedsearch_name by scheduled_times app owner</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">1</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
      <html>
    <a data-unset-token="c1">Close this panel</a>
  </html>
    </panel>
  </row>
  <row>
    <panel depends="$c1$">
      <title>reduce user job quota script generator</title>
      <table>
        <search>
          <query>| rest splunk_server=$captain_name$ /services/authorization/roles |fields title srchJobsQuota id
|search srchJobsQuota&gt;3
| eval new_quota=case(srchJobsQuota&lt;8, "4", srchJobsQuota&gt;=8 AND srchJobsQuota&lt;15, "5", srchJobsQuota&gt;=15 AND srchJobsQuota&lt;25, "6",srchJobsQuota&gt;=25 AND srchJobsQuota&lt;40, "7", srchJobsQuota&gt;=40, "8")
|eval change_script="curl -k -u admin:password -XPOST " + id + " -d " + "rtSrchJobsQuota="+new_quota+ "\" || true"
|eval rollback_script="curl -k -u admin:password -XPOST " + id + " -d " + "rtSrchJobsQuota="+srchJobsQuota+ "\" || true"
|fields srchJobsQuota new_quota title change_script rollback_script</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel depends="$c1$">
      <title>shuffle cron schedule script generator</title>
      <table>
        <search>
          <query>|rest splunk_server=$captain_name$ /servicesNS/-/-/saved/searches
  search="is_scheduled=1" search="disabled=0"
  |fields search title author cron_schedule eai:acl.app eai:acl.sharing dispatch.earliest_time dispatch.latest_time action.summary_index search id
  | search NOT (dispatch.earliest_time=rt* OR dispatch.latest_time=rt* OR action.summary_index=1 OR search=*timechart* OR search=bin OR search=span OR search=*bucket*)
|eval cron_type=case
   (match(cron_schedule,"\*/5 \* \* \* \*"),5,
   match(cron_schedule,"\*/10 \* \* \* \*"),10,
   match(cron_schedule,"\*/15 \* \* \* \*"),15,
   match(cron_schedule,"\*/30 \* \* \* \*"),30,
   match(cron_schedule,"^0 \* \* \* \*"),0,0=0,-1)
| where cron_type &gt;= 0
|sort cron_type
| eval reset_count=case(cron_type=5,4,
                        cron_type=10,9,
                        cron_type=15,14,
                        cron_type=30,29,
                        cron_type=0,59
                        )
| streamstats count reset_after="count=reset_count" by cron_type

| eval lower_bound=count
| eval upper_bound=59
| eval new_cron=case
(
cron_type=0,count .  " * * * *",
cron_type!=0,lower_bound . "-" . upper_bound . "/" . cron_type .  " * * * *"
)
|eval change_script="curl -k -u admin:password -XPOST " + id + " -d " + "cron_schedule=\"" + new_cron + "\" || true"
|eval rollback_script="curl -k -u admin:password -XPOST " + id + " -d " + "cron_schedule=\"" + cron_schedule + "\" || true"
|fields  title author cron_schedule new_cron eai:acl.app eai:acl.sharing change_script rollback_script</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
      <html>
    <a data-unset-token="c1">Close this panel</a>
  </html>
    </panel>
  </row>
  <row>
    <panel>
      <html>

  <p/>
  <b>peak_scheduler_concurrency:</b> = The peak_scheduler_concurrency is calculated based on _introspection logs is counting active searches (PIDs) which should correspond to deleg_size.
    <p/>
<b>captain_computed_scheduler_concurrency:</b> = The captain_computed_scheduler_concurrency is being calculated as sched_size + deleg_size where sched_size is number of searches yet to be dispatched and deleg_size is the searches that are already running in the SHC.
 <p/>
  _introspection log data is logged every 10 sec and metrics.log every 30 sec so it may not reflect short lived search processes. As a result, we don't expect to see the two metrics track each other exactly, however we can use this to spot large discrepancies in the two.
  <p/>

</html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Captain Computed Concurrency (metrics.log) vs Concurrent Running Scheduled Search Processes (peak_scheduler_concurrency) (introspection)</title>
      <chart>
        <search>
          <query>index=_internal search_group="$group$" source=*metrics.log*  group=shclustering name=captain_metrics  | eval active_searches = sched_size + deleg_size | where active_searches &gt; 0       | bin _time span=30s | stats avg(active_searches) AS active_searches by _time | join _time [search  index=_introspection search_group="$group$" source=*resource_usage.log* component=PerProcess data.search_props.sid::* data.search_props.type="scheduled"       | bin _time span=10s       | stats dc(data.search_props.sid) AS distinct_search_count by _time, host       | stats sum(distinct_search_count) AS clusterwide_scheduler_concurrency by _time]       | timechart span=10s max(clusterwide_scheduler_concurrency) AS peak_scheduler_concurrency max(active_searches) AS captain_computed_scheduler_concurrency partial=false |join splunk_server_group  [| rest splunk_server_group="$group$" splunk_server_group=dmc_group_search_head "/services/server/status/limits/search-concurrency?cluster_wide_quota=1"
              | stats max(max_hist_scheduled_searches) as "scheduler concurrency limit" ]</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.overlayFields">"scheduler concurrency limit"</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>time spent (&gt;1000ms) in shcluster/member/delegatejob endpoint of shc members</title>
      <table>
        <title>spent represents how long it took to create the search artifact directory on the member</title>
        <search>
          <query>index=_internal search_group=dmc_group_search_head search_group="$group$" source=*splunkd_access.log* /shcluster/member/delegatejob/ spent&gt;1000  | stats values(spent) as spent_ms by host uri_path</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">1</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <input type="multiselect" token="status1" searchWhenChanged="true">
        <label>status</label>
        <choice value="*">all</choice>
        <choice value="skipped">skipped</choice>
        <choice value="deferred">deferred</choice>
        <prefix>status=</prefix>
        <delimiter> OR status=</delimiter>
      </input>
      <table>
        <title>search runtime &amp; cron schedule</title>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server="$captain_name$" | where is_scheduled=1 | search disabled=0  | stats count by  title next_scheduled_time cron_schedule schedule_priority schedule_window dispatch.earliest_time dispatch.latest_time| fields title next_scheduled_time cron_schedule schedule_priority schedule_window dispatch.earliest_time dispatch.latest_time| rename title as savedsearch_name | join savedsearch_name [search index=_internal  source=*scheduler.log* $status1$  savedsearch_name=*| fillnull value=NA reason] | join savedsearch_name [search index=_internal search_group=dmc_group_search_head search_group="$group$" sourcetype=scheduler  status=*  dispatch_time=*
| eval runtime_delay= (dispatch_time-scheduled_time) | stats avg(runtime_delay) as avg_runtime_delay avg(run_time) as avg_runtime max(run_time) as max_runtime by savedsearch_name | eval avg_runtime_delay=round(avg_runtime_delay,0)| eval avg_runtime=round(avg_runtime,0) | eval max_runtime=round(max_runtime,0)| rename avg_runtime_delay as "avg_runtime_delay(sec)" avg_runtime as avg_runtime(sec) max_runtime as max_runtime(sec) | sort - "max_runtime(sec)"] | table savedsearch_name status reason avg_runtime(sec) max_runtime(sec) cron_schedule | sort -max_runtime(sec)</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <drilldown>
          <set token="ss1">$click.value2$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel depends="$ss1$">
      <title>search runtime for $ss1$</title>
      <html>
    <a data-unset-token="ss1">Close this panel</a>
  </html>
      <chart>
        <search>
          <query>index=_internal search_group=dmc_group_search_head search_group="$group$" sourcetype=scheduler  status=*  dispatch_time=* savedsearch_name=$ss1$
| eval runtime_delay= (dispatch_time-scheduled_time) | timechart avg(runtime_delay) as avg_runtime_delay avg(run_time) as avg_runtime max(run_time) as max_runtime by savedsearch_name useother=f limit=0</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">zero</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">1</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <html>
                 <style>.btn-primary { margin: 5px 10px 5px 0; }</style>
                 <a target="_blank" href="support_indexing_performance" class="btn btn-primary">continue investigation by looking at Indexer Performance </a>
             </html>
    </panel>
  </row>
</form>
